### 2.4.2 마이크로서비스 운영과 관리를 위한 플랫폼 패턴

#### 중앙화된 로그 집계 패턴

마이크로서비스의 로그는 어떻게 관리해야 할까?

- 마이크로서비스가 사용량에 따라 탄력적으로 변화하면서 언제든지 인스턴스가 생성/삭제되는 과정에서 **로컬 로그가 초기화될 수 있다**.

Twelve-Factor의 '로그'원칙을 보면,

- **로그를 이벤트 스트림**으로 처리하라고 한다.
- 로그는 시작과 끝이 고정된 것이 아니라 **서비스가 실행되는 동안 계속 흐르는 흐름**이다!
- 그리고 서비스는 **스트림의 전달이나 저장에 절대 관여하지 않아야** 한다.
    - 왜냐하면, **로그를 전달 및 저장하는 메커니즘 자체가 특정 기술이나 인프라에 의존할 수밖에** 없고
    - 이러한 메커니즘을 **직접 마이크로서비스에서 구현한다면 유연성이 떨어지기 때문**

**-> 그래서 필요한 것이 중앙화된 로그 집계 패턴**

- 서비스에서 발생한 이벤트 스트림 형태의 로그를 수집하고 살표볼 도구가 필요한데, 대표적으로 많이 쓰이는 기술이 **ELK 스택**

- 여기서 ElasticSearch는 분석 엔진, Logstash는 서버 측 로그 집합기 , Kibana는 시각적으로 로그 내역을 보여주는 대시보드

| 이름            | 설명                                                                         |
|---------------|----------------------------------------------------------------------------|
| Elasticsearch | **분산형 검색 / 분석 엔진** <br/>정형, 비정형, 위치 정보, 메트릭 등 원하는 방법으로 검색을 수행 / 결합 기능      |
| Logstash      | **로그 집합기**<br/>데이터 처리 파이프라인, 다양한 소스에서 동시에 데이터를 수집해 변환한뒤 -> 특정 보관소로 데이터를 보냄 |
| Kibana        | **시각화**<br/>히스토그램, 막대 그래프, 파이차트 등 표현, 위치 데이터, 시계열 분석, 그래프 관계 탐색 등 지원       |


ELK 스택을 이용하면 -> 각 서비스의 인스턴스 로그를 집곗해서 중앙에서 집중관리할 수 있으며, 

손쉽게 특정 로그를 검색 및 분석할 수 있다. 

또한, 특정 메세지가 로그에 나타나거나 특정 예외가 발생할 때 운영자나 개발자에게 직접 통보하게 할 수도 있다.

**로그 집계 아키텍처**
- 각 서비스에 Logstash가 설치되어 각 로그를 수집해서 -> Redis 저장소에 보낸다. -> 또 다른 서비스에서는 엘라스틱서치와 키바나로 로그 중앙 관리 저장소와 대시보드 서비스를 각각 구축
- 마이크로서비스에서 보낸 로그가 -> 중앙 레디스에 쌓이면 -> 레디스에서 중앙 관리 저장소에 로그를 보내고, 이 로그 저장소에 엘라스틱 서치 엔진이 로그를 인덱싱하고 -> 해당 로그 정보가 키바나 대시보드를 통해 보여진다. 

> **중간에 레디스 를 둔이유?**
> - 마이크로서비스의 Logstash가 바로 로그 저장소에 로그를 보낼 수 있지만,
> - 로그 스트림이 너무 몰리면 -> 로그 저장소 서비스에도 성능 문제가 생기기 때문에 -> 중간에 임시 저장소를 추가

