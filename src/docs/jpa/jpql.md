# JPQL 

## 프로젝션 
- SELECT 절에 조회할 대상을 지정하는 것 

- 프로젝션 대상 
  - 엔티티
  - 임베디드 타입
  - 스칼라 타입 

### 엔티티 
말 그대로 엔티티를 조회하는 것!

### 임베디드 타입 (값타입)
- 엔티티와 거의 비슷하게 사용 
- 엔티티를 조회하는 것이 아니라, **임베디드 타입 (값 타입)을 조회하는 것**

- **임베디드 타입은 엔티티 타입이 아닌 값 타입이다**
  - 따라서 이렇게 직접 조회한 임베디드 타입은 **영속성 컨텍스트에서 관리 X**

### 스칼라 타입 
- 기본 데이터 타입들을 스칼라 타입이라고 함
- 중복 데이터를 제거하려면 `DISTINCT`를 사용하자!

### 여러 값 조회 
- 꼭 필요한 컬럼들만 선택해서 조회할 때 
- 프로젝션에 여러 값을 선택하면 `TypedQuery`를 사용할 수 없고, 
  - 대신에 `Query` 를 사용해야한다!
  - `List<Object[]>` 이렇게 사용하면 편리하다 
- 하지만 이렇게 사용하면 타입이 안전하지 않다. 

### NEW 명령어 
- `SELECT` 절에서 `NEW` 명령어를 사용하면, 
  - 반환 받을 클래스를 지정할 수 있다 

```text
"SELECT new me.wane.MemberDTO(m.username, m.age) FROM Member m"
```
#### NEW 명령어 사용시 주의사항 
1. 패키지 명을 포함한 전체 클래스 명을 입력
2. 순서와 타입이 일치하는 생성자가 필요!


### 집합과 정렬 
- 집합은 집합함수와 함께 통계 정보를 구할 때 사용

#### 집합 함수 
1. **COUNT** : 결과 수, 반환타입 Long 
2. **MAX, MIN** : 최대, 최소 값  (문자, 숫자, 날짜 등에 사용 가능!)
3. **AVG** : 평균값, 반환타입 Double  (숫자 타입만 사용 가능)
4. **SUM** : 합, 반환타입 Long, Double... (숫자 타입만 사용 가능)


#### 집합 함수 주의사항 

- **NULL 값은 무시**해서 -> 통계에 잡히지 않는다 (DISTINCT 있어도 무시)
- 값이 없는데 `SUM, AVG, MAX, MIN`함수를 사용하면 **NULL 반환**
- `COUNT`는 0
- `DISTINCT`를 **집합 함수 안에 사용**해서 중복된 값을 제거하고 나서 집합을 구할 수 있다.
- `DISTINCT`를 COUNT 에서 사용할 때 임베디드 타입(값 타입)은 지원 X


## JPQL 조인 
#### 내부 조인 
- `INNER JOIN`, `INNER` 생략 가능!


### 조인 주의 사항 
- SQL 조인처럼 사용하면 문법 오류 발생
  - 
```sql
select m from Member m join m.team t
```

#### 외부 조인 
- `LEFT OUTER JOIN`, `OUTER` 생략 가능!


#### 컬렉션 조인 
- 일대다 , 다대다 관계 처럼 컬렉션을 사용하는 곳에 조인하는 것을 컬렉션 조인

#### 세타 조인 
- **WHERE 절**에서 사용가능
- **내부 조인만 지원**
- 전혀 관계없는 엔티티도 조인 가능!


#### JOIN ON 절 
- ON 절을 사용하면 **조인 대상을 필터링 가능**!
- **외부 조인에서 주로 사용** 
  - **내부 조인의 ON 절은 `WHERE` 절을 사용할 때와 같다!**

#### fetch 조인 
- JPQL 에서 **성능 최적화를 위해** 제공되는 기능!
- **연관된 엔티티나 컬렉션을 한 번에 같이 조회**하는 기능
- `join fetch`
```text
[ LEFT | INNER ] JOIN FETCH
```

#### fetch 조인 주의사항
- 지연 로딩으로 설정 해도 -> **fetch 조인으로 설정하면 즉시 로딩으로 동작**
- 프록시가 아닌 실제 엔티티이므로 `join fetch 한 테이블도` **영속성 컨텍스트에서 관리**


### 묵시적 조인

- 경로 탐색을 사용하면 (t.members) -> 묵시적 조인이 발생해서 SQL 에서 내부 조인이 일어날 수 있다
- 묵시적 조인은 항상 **내부 조인**이다
- **컬렉션은 경로 탐색의 끝** 
  - 컬렉션에서 경로 탐색을 하려면 **명시적으로 조인해서 별칭을 얻어야 한다** 
    - e.x. `select m.username from Team t join t.members m`
- 경로 탐색은 주로 SELECT, WHERE 절에서 사용하지만 **묵시적 조인으로 인해 SQL 에서 조인이 일어날 수 있으니 주의!**

- 묵시적 조인은 조인이 일어나는 상황을 한눈에 파악하기 어렵다 
- 성능이 중요하면 분석하기 쉽도록 묵시적 조인보다는 **명시적 조인을 사용하자**


